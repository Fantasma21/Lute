<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lute PvP</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="screen" width="800" height="400"></canvas>

  <script src="/socket.io/socket.io.js"></script>

  <script type="module">
    import { updateState, startRenderLoop, setLocalPlayerId } from "./render.js";

    const socket = io();

    const playerName = localStorage.getItem("playerName");
    const roomId = localStorage.getItem("roomId");

    if (!playerName || !roomId) {
      alert("Falta nome ou sala!");
      window.location.href = "index.html";
    }

    // entrar na sala
    socket.emit("join-room", { playerName, roomId });

    socket.on("room-full", () => {
      alert("Sala cheia!");
      window.location.href = "index.html";
    });

    // servidor confirma login e devolve o id do socket
    socket.on("login-success", (data) => {
      setLocalPlayerId(data.playerId);
    });

    // recebe estado (autoritative)
    socket.on("state", (state) => {
      updateState(state);
    });

    // inputs simples (enviamos sempre o estado atual do input)
    const input = { left: false, right: false, up: false, attack: false };

    function sendInput() {
      socket.emit("input", input);
    }

    window.addEventListener("keydown", (e) => {
      if (e.key === "a" || e.key === "ArrowLeft") { input.left = true; sendInput(); }
      if (e.key === "d" || e.key === "ArrowRight") { input.right = true; sendInput(); }
      if (e.key === "w" || e.key === "ArrowUp") { input.up = true; sendInput(); }
      if (e.key === " ") { input.attack = true; sendInput(); }
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "a" || e.key === "ArrowLeft") { input.left = false; sendInput(); }
      if (e.key === "d" || e.key === "ArrowRight") { input.right = false; sendInput(); }
      if (e.key === "w" || e.key === "ArrowUp") { input.up = false; sendInput(); }
      if (e.key === " ") { input.attack = false; sendInput(); }
    });

    // inicia loop de render (render.js exporta startRenderLoop)
    startRenderLoop();
  </script>
</body>
</html>
